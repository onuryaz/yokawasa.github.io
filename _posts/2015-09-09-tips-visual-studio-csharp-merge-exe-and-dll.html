---
layout: post
status: publish
published: true
title: C Sharpで実行ファイルにDLLをスタティックリンクさせたい
author:
  display_name: Yoichi Kawasaki
  login: yoichi
  email: yokawasa@gmail.com
  url: http://github.com/yokawasa
author_login: yoichi
author_email: yokawasa@gmail.com
author_url: http://github.com/yokawasa
wordpress_id: 45
wordpress_url: http://unofficialism.info/posts/?p=45
date: '2015-09-09 00:12:47 +0900'
date_gmt: '2015-09-08 15:12:47 +0900'
categories:
- TIPS
tags:
- CSharp
- VisualStduio
- ILMerge
---
<p>Q1. C Sharpでexeに複数DLLをスタティックリンクさせて１ファイルにすることはできますか？</p>
<p>C、C++ではおなじみのスタティックリンクだが、そもそもC Sharpではスタティックリンクができない。ただし<br />
MS Research謹製の<a href="http://www.microsoft.com/en-us/download/details.aspx?id=17630" target="_blank">ILMerge</a>を使えば実行ファイル(exe)に対して複数のクラスアセンブリ(DLL)を１つのアセンブリにマージすることはできる。使い方は<a href="http://www.atmarkit.co.jp/fdotnet/dotnettips/426ilmerge/ilmerge.html">こちら</a>が参考になる。また、<a href="https://ilmergegui.codeplex.com/">ILMerge-GUI</a>というGUIツールもある。</p>
<p>Q2. Visual Studioのビルドでも自動的に複数ファイルを１つにまとめることはできますか？</p>
<p>パッケージマネージャーでILMerge.MSBuild.Tasksをインストールして*.csprojファイルに自動アセンブリ生成するための設定を追記するとVSのビルドで複数ファイルが１つのアセンブリにマージされたファイルが自動的にできあがる。参考: StackOverflow 「<a href="http://stackoverflow.com/questions/2556048/how-to-integrate-ilmerge-into-visual-studio-build-process-to-merge-assemblies">How to Integrate ILMerge into Visual Studio Build Process to Merge Assemblies?</a>」</p>
<p>1) ILMerge.MSBuild.Tasksをインストール<br />
<code><br />
PM> Install-Package ILMerge.MSBuild.Tasks<br />
</code></p>
<p>2) *.csprojファイルに下記設定を追記<br />
<code lang="xml"><br />
  <!-- Code to merge the assemblies into one --><br />
  <UsingTask TaskName="ILMerge.MSBuild.Tasks.ILMerge" AssemblyFile="$(SolutionDir)\packages\ILMerge.MSBuild.Tasks.1.0.0.3\tools\ILMerge.MSBuild.Tasks.dll" /><br />
  <Target Name="AfterBuild"><br />
    <ItemGroup><br />
      <MergeAsm Include="$(OutputPath)$(TargetFileName)" /><br />
      <MergeAsm Include="$(OutputPath)追加するDLLファイル名1" /><br />
      <MergeAsm Include="$(OutputPath)追加するDLLファイル名2" /><br />
       ...<br />
      <MergeAsm Include="$(OutputPath)追加するDLLファイル名N" /><br />
    </ItemGroup><br />
    <PropertyGroup><br />
      <MergedAssembly>出力する結果アセンブリファイル名（フルパス）</MergedAssembly><br />
    </PropertyGroup><br />
    <Message Text="ILMerge @(MergeAsm) -> $(MergedAssembly)" Importance="high" /><br />
    <ILMerge InputAssemblies="@(MergeAsm)" OutputFile="$(MergedAssembly)" TargetKind="SameAsPrimaryAssembly" /><br />
  </Target><br />
</Project><br />
</code></p>
<p>3) VSビルド実行で、マージされたファイルが生成（*.csprofのMergedAssemblyで指定したファイル名）</p>
<p>尚、<a href="http://unofficialism.info/posts/azure-media-services-get-all-assets-list/">前記事</a>のコンソールアプリの<a href="https://github.com/yokawasa/azure-samples/tree/master/ams-list-assets">サンプルコード</a>では&lsquo;*.csprojファイルに<a href="https://github.com/yokawasa/azure-samples/blob/master/ams-list-assets/ams-list-assets/ams-list-assets.csproj">この設定</a>を追加しており、VSビルドで自動的に1アセンブリにマージされたexeファイルが生成されるようにしている。</p>
