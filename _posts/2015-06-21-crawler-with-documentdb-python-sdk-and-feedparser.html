---
layout: post
status: publish
published: true
title: DocumentDB Python SDKとfeedparserで作る簡易クローラー
author:
  display_name: Yoichi Kawasaki
  login: yoichi
  email: yokawasa@gmail.com
  url: http://github.com/yokawasa
author_login: yoichi
author_email: yokawasa@gmail.com
author_url: http://github.com/yokawasa
wordpress_id: 31
wordpress_url: http://unofficialism.info/posts/?p=31
date: '2015-06-21 17:32:40 +0900'
date_gmt: '2015-06-21 08:32:40 +0900'
categories:
- Azure
tags:
- DocumentDB
- NoSQL
- Python
- Crawler
- pydocumentdb
- feedparser
---
<p>DocumentDB Python SDKとfeedparserを使って簡易クローラーを作りましょうというお話。ここではDocumentDBをクローリング結果の格納先データストアとして使用する。クロール対象は<a href="http://blogs.msdn.com/b/windowsazurej/" target="_blank">Azure日本語ブログ</a>の<a href="http://blogs.msdn.com/b/windowsazurej/atom.aspx" target="_blank">RSSフィード</a>、これをfeedparserを使ってドキュメント解析、必要データの抽出、そしてその結果を今回使用するpydocumentdbというDocumentDB Python SDKを使ってDocumentDBに格納するというワークフローになっている。</p>
<h2>DocumentDB Python SDK - pydocumentdb</h2>
<p>Azureで提供されているどのサービスにもあてはまることであるが、DocumentDBを操作するための全てのインターフェースはREST APIとして提供されておりREST APIを内部的に使用してマイクロソフト謹製もしくは個人のコントリビューションによる複数の言語のSDKが用意されている。その中でもpydocumentdbはPython用のDocumentDB SDKであり、オープンソースとしてソースコードは全てGithubで公開されている。</p>
<ul style="list-style:disc inside">
<li><a href="https://github.com/Azure/azure-documentdb-python" target="_blank">pydocumentdbプロジェクトトップ(Github)</a></li>
<li><a href="https://github.com/Azure/azure-documentdb-python/blob/master/test/crud_tests.py" target="_blank">pydocumentdbサンプルコード(Github)</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/azure/dn781481.aspx" target="_blank">Azure DocumentDB REST API Reference</a></li>
</ul>
<h2>Pre-Requirementsその１: Python実行環境とライブラリ</h2>
<p>実行環境としてPython2.7系が必要となる。また、今回クローラーが使用しているDocumentDB Python SDKである<a href="https://github.com/Azure/azure-documentdb-python" target="_blank">pydocumentdb</a>とRSSフィード解析ライブラリ<a href="https://github.com/kurtmckee/feedparser" target="_blank">feedparser</a>の２つのライブラリのインストールが必要となる。</p>
<ul style="list-style:disc inside">
<li>pydocumentdbインストール</li>
<p><code><br />
sudo pip install pydocumentdb<br />
</code></p>
<li>feedparserインストール</li>
<p><code><br />
sudo pip install feedparser<br />
</code></p>
<p>
ちなみにpipがインストールされていない場合は下記の通りマニュアルもしくはインストーラーを使用してpipをインストールが必要となる</p>
<li>pip マニュアルインストール</li>
<p><code><br />
# download get-pip.py<br />
wget https://bootstrap.pypa.io/get-pip.py<br />
#  run the following (which may require administrator access)<br />
sudo python get-pip.py<br />
# upgrade pip<br />
sudo pip install -U pip<br />
</code></p>
<li>インストーラーを使用</li>
<p><code><br />
# apt-getの場合<br />
sudo apt-get install python-pip<br />
# yumの場合<br />
sudo yum install python-pip<br />
</code>
</ul>
<h2>Pre-requirementsその２: DocumentDBアカウント</h2>
<p>Azure新ポータルより下記イメージのフローでDocumentDBアカウントを作成する。</p>
<p><center><br />
<img src="https://c1.staticflickr.com/1/345/18984569836_dcbd5e82b7_z.jpg" width="640" height="333" alt="DocumentDB-Account-Create"><br />
</center></p>
<p>DocumentDBアカウントを作成したら今度はデータを格納するためのDocumentDBデータベースとコレクションを作成する必要がある。DocumentDBデータベースとコレクションはAzure新ポータルから作成可能であるが、今回のクローラープログラムではpydocumentdbを使って作成するようにしている。</p>
<h2>RSSクローラーとその実行結果</h2>
<p>RSSクローラーのソースコード（<a href="https://gist.github.com/yokawasa/e41c1517700ebc6f67df" target="_blank">rssCrawler4Docdb.py</a>）とその実行結果は下記の通り。もしクローリングを定期的に実行する場合はこのスクリプトをジョブスケジューラー（cronなど）に登録ください。指定のRSSフィードに新しく追加された記事のみがDocumentDBに反映されるようスクリプト上は重複チェックを入れている。</p>
<p><script src="https://gist.github.com/yokawasa/e41c1517700ebc6f67df.js"></script></p>
<p>[実行結果]<br />
<code><br />
database is created:feeddb<br />
collection is created:article_collection<br />
document is added:title:業界トップのクラウド アナリストがマイクロソフトに転身した理由<br />
document is added:title:Azure Linux VM のインフラストラクチャの監視と診断<br />
document is added:title:Azure App Service の Web アプリ用 Support Site Extension の追加更新<br />
document is added:title:Azure CDN でカスタムのオリジン サーバーをサポート<br />
document is added:title:Tinfoil Security の Azure App Service 向け Web 脆弱性スキャン機能<br />
document is added:title:Azure Site Extensions の自動更新が可能に<br />
document is added:title:DocumentDB へのデータのインポートがより高速、簡単に<br />
document is added:title:Query Store: データベース版フライト データ レコーダー機能<br />
document is added:title:Azure App Service の Web アプリで使用される TLS の中間証明書<br />
document is added:title:Azure で Cloud Foundry をお試しください<br />
document is added:title:Azure Media Indexer の更新版 v1.2.1 をリリース: 前回からの修正点について<br />
document is added:title:クラウド環境でエンドツーエンドのビデオ ワークフローを構築する<br />
document is added:title:Azure Media Player の更新と UserVoice フォーラムのお知らせ<br />
document is added:title:Microsoft Azure 関連ニュース 2015 年 5 月のまとめ<br />
document is added:title:Azure Media Services 向け Hyperlapse のパブリック プレビューを発表<br />
document is added:title:6 月 1 日以降の Application Insights の料金設定<br />
document is added:title:StorSimple Update 1 を発表: Azure Government で提供開始、他社クラウドと ZRS をサポート、5000/7000 シリーズからの移行に対応<br />
document is added:title:成功から転落の危機に直面した Sleeve Music。経験豊かな開発者と適切なツールの選択で新たなアイデアを創出<br />
document is added:title:Azure Storage に関する Build 2015 での発表<br />
document is added:title:Visual Studio Code と Azure App Service の連携で実現できること<br />
document is added:title:Azure Automation でグラフィック形式とテキスト形式の作成機能を導入<br />
document is added:title:接続性の高い安定したハイブリッド クラウドの実現に向けた新しいネットワーク機能<br />
document is added:title:DocumentDB の新しいインポート オプション<br />
document is added:title:Azure Site Recovery が NetApp Private Storage for Microsoft Azure をサポート<br />
document is added:title:Application Insights で ASP.NET 5 アプリケーションをサポート<br />
</code></p>
