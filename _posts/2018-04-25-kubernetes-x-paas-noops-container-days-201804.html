---
layout: post
status: publish
published: true
title: Kubernetes x PaaS コンテナアプリケーションのNoOpsへの挑戦 (Japan Container Days v18.04)
author:
  display_name: Yoichi Kawasaki
  login: yoichi
  email: yokawasa@gmail.com
  url: http://github.com/yokawasa
author_login: yoichi
author_email: yokawasa@gmail.com
author_url: http://github.com/yokawasa
wordpress_id: 146
wordpress_url: http://unofficialism.info/posts/?p=146
date: '2018-04-25 13:40:40 +0900'
date_gmt: '2018-04-25 04:40:40 +0900'
categories:
- Azure
- Kubernetes
tags:
- Container
- Kubernetes
- Azure Container Instances
- AKS
- Istio
- Open Service Broker
- Helm
---
<p>先日、4月19日に開催された<a href="https://containerdays.jp/">Japan Container Days v18.04</a>にて「Kubernetes x PaaS &ndash; コンテナアプリケーションのNoOpsへの挑戦」というタイトルでセッションを担当させていただいた。その名の通りメインがKubernetesで、KubernetesアプリケーションにおいてNoOps（運用レス）を目指すためのにどういった工夫ができるのか、どういったものを活用していけばよいのか、という内容です。このブログではJapan Container Daysでの発表に使用したスライドの共有とセッションに中のサンプルやデモについて補足させていただく。</p>
<h1>Session Slides</h1>
<p><iframe src="//www.slideshare.net/slideshow/embed_code/key/97OZsvtB6qEaVv" width="700" height="570.5" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>
<div style="margin-bottom:5px"> <strong> <a href="//www.slideshare.net/yokawasa/kubernetes-x-paas-noops" title="Kubernetes x PaaS &ndash; コンテナアプリケーションの NoOpsへの挑戦" target="_blank">Kubernetes x PaaS &ndash; コンテナアプリケーションの NoOpsへの挑戦</a> </strong> from <strong><a href="https://www.slideshare.net/yokawasa" target="_blank">Yoichi Kawasaki</a></strong> </div>
<h1>補足情報</h1>
<h2>1. Open Service Broker for AzureでAzure Database for MySQLの利用</h2>
<p>スライドでお見せした実際のファイルを使ってAzure Database for MySQLのサービスインスタンス作成、バインディング、そして実際のアプリケーションからの利用までの流れを紹介させていただく。</p>
<p>Open Service Broker for AzureプロジェクトのGithubにあるサンプルファイル<a href="https://github.com/Azure/open-service-broker-azure/blob/master/contrib/k8s/examples/mysql/mysql-instance.yaml">mysql-instance.yaml</a>と<a href="https://github.com/Azure/open-service-broker-azure/blob/master/contrib/k8s/examples/mysql/mysql-binding.yaml">mysql-binding.yaml</a>を使ってそれぞれServiceInstanceとServiceBindingを作成する<br />
<code><br />
# Provisioning the database, basic50 plan ...<br />
kubectl create -f mysql-instance.yaml</p>
<p># Wait until ServiceInstance named example-mysql-instance get ready 'Status => Ready',<br />
# then execute the following to create a binding for this new database,<br />
kubectl create -f mysql-binding.yaml<br />
</code><br />
これでexample-mysql-secretという名前のシークレットオブジェクトが作成され、そこにアプリケーションがAzure Database for MySQLインスタンスとの接続必要な情報が格納される。ここではMySQLに接続して単純な処理をするだけのPythonアプリでテストする。アプリをデプロイメントのために下記YAMLを用意したが注目すべきはYAMLの中でMySQLの接続必要な情報をシークレットexample-mysql-secretから取得している点。<br />
<script src="https://gist.github.com/yokawasa/c296be9321e4c527420a35c720cf27e0.js"></script></p>
<p>また、アプリケーションの中ではYAMLで指定された環境変数からMySQL接続に必要な情報を取得している。</p>
<p><script src="https://gist.github.com/yokawasa/0e8e9479b8dec40fad1eaf8c3ac80808.js"></script></p>
<p>それでは次のようにアプリケーションをデプロイする<br />
<code><br />
kubectl create -f mysql-deploy.yaml<br />
</code></p>
<p>全ての過程が問題なければ、デプロイ後のPodのログをみると、下記のような出力が確認できるはずだ。これはアプリケーションがMySQLとの接続して処理が行われたことを表す。ここでは<a href="https://github.com/wercker/stern">stern</a>を使ってログを参照している。<br />
<code><br />
stern <アプリケーションのPod名></p>
<p>+ sample-osba-mysql-684ccd679f-nl252 &rsaquo; osba-mysql-demo<br />
sample-osba-mysql-684ccd679f-nl252 osba-mysql-demo o36e6ivtni@8ae3fca5-9b5c-471b-99d8-0eeb567c6acb<br />
sample-osba-mysql-684ccd679f-nl252 osba-mysql-demo sE8UFm5cN4tgIeNF<br />
sample-osba-mysql-684ccd679f-nl252 osba-mysql-demo 8ae3fca5-9b5c-471b-99d8-0eeb567c6acb.mysql.database.azure.com<br />
sample-osba-mysql-684ccd679f-nl252 osba-mysql-demo v8i0xxlerz<br />
sample-osba-mysql-684ccd679f-nl252 osba-mysql-demo ===== table list =====<br />
sample-osba-mysql-684ccd679f-nl252 osba-mysql-demo ('test',)<br />
sample-osba-mysql-684ccd679f-nl252 osba-mysql-demo ===== Records =====<br />
sample-osba-mysql-684ccd679f-nl252 osba-mysql-demo Id: 1 Content: hoge<br />
sample-osba-mysql-684ccd679f-nl252 osba-mysql-demo Id: 2 Content: foo<br />
sample-osba-mysql-684ccd679f-nl252 osba-mysql-demo Id: 3 Content: bar<br />
</code></p>
<h2>2. デモ - Virtual Kubelet + Azure Container Instances</h2>
<p><iframe width="560" height="315" src="https://www.youtube.com/embed/2GdXGvIOo40" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></p>
<p>全てのデモマテリアルと手順は下記Githubプロジェクトを元に実施</p>
<p>デモコード: <a href="https://github.com/rbitia/aci-demos">https://github.com/rbitia/aci-demos</a></p>
<h2>3. デモ - Traffic Routing with Istio</h2>
<p><iframe width="560" height="315" src="https://www.youtube.com/embed/P_FFLvaMIX8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></p>
<p>セッション中に時間が足りなくてチラ見せ程度しかお見せできなかったサービスメッシュにIstio（Istio-0.5.0）を使ったトラフィックルーティングデモ。せっかくなのでここで全ての手順を紹介させていただく。アプリな単純なコンテナイメージのタグ名を表示するだけの<a href="https://github.com/yokawasa/docker-image-samples/tree/master/python-version-app">Flaskアプリ</a>を利用している</p>
<p><u>必要ファイル一覧</u></p>
<ul style="list-style:disc inside">
<li><a href="https://gist.github.com/yokawasa/bd675fec7f6e3246cdef278605203575">myversion-v1.yaml</a></li>
<li><a href="https://gist.github.com/yokawasa/704d7263995c55b43252083aa2479a5c">myversion-v2.yaml</a></li>
<li><a href="https://gist.github.com/yokawasa/8b1dfd352b6971fd3f194c7800886d47">route-default-v1.yaml</a></li>
<li><a href="https://gist.github.com/yokawasa/5fe5f93b88a87b7113a4ca81aa9b8e1d">route-canary.yaml</a></li>
<li><a href="https://gist.github.com/yokawasa/f7263456b20c8576ceff7c53759d0e8d">route-conditional-v2.yaml</a></li>
</ul>
<p>まずはV1とV2アプリケーションのデプロイメント。ここではアプリケーションのManifestに対してistioctlのkube-injectでIstioの設定が組み込まれたManifestを元にデプロイメントしている。</p>
<p><code><br />
## ver1.0<br />
kubectl apply -f <(istioctl kube-inject --debug -f myversion-v1.yaml)<br />
## ver2.0<br />
kubectl apply -f <(istioctl kube-inject --debug -f myversion-v2.yaml)<br />
</code></p>
<p>上記のデプロイメントで作られたIngressコントローラーのIP、PORTを取得を次のように取得する。サンプルで使用しているFlaskアプリで指定しているエンドポイントが/versionであるからアプリケーションのエンドポイントはGATEWAY_IP:GATEWAY_PORT/versionがとなる。</p>
<p><code><br />
GATEWAY_IP=$(kubectl get po -n istio-system -l \<br />
        istio=ingress -n istio-system \<br />
        -o 'jsonpath={.items[0].status.hostIP}')<br />
GATEWAY_PORT=$(kubectl get svc istio-ingress \<br />
        -n istio-system -n istio-system \<br />
        -o 'jsonpath={.spec.ports[0].nodePort}')<br />
GATEWAY_URL=$GATEWAY_IP:$GATEWAY_PORT<br />
echo $GATEWAY_URL<br />
</code></p>
<p>まずは、Istioに全てのトラフィックをv1アプリにルーティングするように設定する</p>
<p><code><br />
istioctl create -f route-default-v1.yaml<br />
</code></p>
<p>次のように連続でアクセスして全てのトラフィックがV1にルーティングされていることを確認<br />
<code><br />
while true; do curl http://${GATEWAY_URL}/version; sleep 1; done</p>
<p>I am v1.111111111<br />
I am v1.111111111<br />
I am v1.111111111<br />
I am v1.111111111<br />
</code></p>
<p>続いて、Istioにさきほどの100% V1の設定を削除して、新しく90%のトラフィックをv1アプリに 10%をV2アプリにルーティングするように設定する</p>
<p><code><br />
istioctl delete routerule myversion-default-v1 -n default<br />
istioctl create -f route-canary.yaml<br />
</code></p>
<p>前と同様に連続でアクセスして90%のトラフィックはV1に、10％はV2にルーティングされていることを確認<br />
<code><br />
while true; do curl http://${GATEWAY_URL}/version; sleep 1; done</p>
<p>I am v1.111111111<br />
I am v1.111111111<br />
I am v1.111111111<br />
I am v2.222222222  ... たまにV2<br />
I am v1.111111111<br />
</code></p>
<p>最後に、Istioに特定の条件でのみ100%のトラフィックをV2アプリ向けるように設定する。下記設定ファイルroute-conditional-v2.yamlに記述されているように、ここではHTTPヘッダのuserの値が"yoichi"であることを特定の条件とする。</p>
<p><script src="https://gist.github.com/yokawasa/f7263456b20c8576ceff7c53759d0e8d.js"></script></p>
<p>Istioに特定条件用のルーティング設定を追加</p>
<p><code><br />
istioctl create -f route-conditional-v2.yaml<br />
</code></p>
<p>次のようにヘッダーに"user: yoichi"の条件を追加して連続でアクセスして全てのトラフィックがV2にルーティングされていることを確認<br />
<code><br />
while true; do curl -H "user: yoichi" http://${GATEWAY_URL}/version; sleep 1; done</p>
<p>I am v2.222222222<br />
I am v2.222222222<br />
I am v2.222222222<br />
I am v2.222222222<br />
</code></p>
<p>以上、補足情報でした。</p>
<h3>Links</h3>
<ul style="list-style:disc inside">
<li><a href="https://containerdays.jp/">Japan Container Days v18.04</a></li>
<li><a href="https://github.com/Azure/open-service-broker-azure">Open Service Broker API Server for Azure</a></li>
<li><a href="https://azure.microsoft.com/en-us/services/container-instances/">Azure Container Instances</a></li>
<li><a href="https://github.com/virtual-kubelet/virtual-kubelet">Virtual Kubelet</a></li>
<li><a href="https://archive.istio.io/v0.5/docs/setup/">Istio-0.5.0 Document</a></li>
</ul>
