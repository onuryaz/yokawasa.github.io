---
layout: post
status: publish
published: true
title: PythonによるAzure Functions アプリ開発 - Experimental編
author:
  display_name: Yoichi Kawasaki
  login: yoichi
  email: yokawasa@gmail.com
  url: http://github.com/yokawasa
author_login: yoichi
author_email: yokawasa@gmail.com
author_url: http://github.com/yokawasa
wordpress_id: 137
wordpress_url: http://unofficialism.info/posts/?p=137
date: '2017-12-29 17:13:02 +0900'
date_gmt: '2017-12-29 08:13:02 +0900'
categories:
- Azure
tags:
- Python
- AzureFunctions
- Serverless
---
<p>今年もあと少し。ほぼ趣味の範囲を超えないレベルで今年取り組んだテーマの１つにAzure Functions with Pythonがある。あまり情報が無い中、興味本位でサンプルコードを作っては動かして試して得られた情報をシコシコとGithubに上げているうちにナレッジが溜まって来た。それほど多くはないと思うがPythonでAzure Functionsアプリを作りたいという人もいると思うのでノウハウをブログにまとめておく。いきなり水を差すようではあるが、現時点（2017年12月）ではAzure FunctionsのPythonサポータビリティはExperimental（実験的サポート）でありプロダクション向きではない状況であるので、ホントにPythonが好きな人がOn your own riskで楽しんでいただければと思う。</p>
<h2>Azure FunctionsのPythonサポート状況</h2>
<p>Azure FunctionsのRuntimeには大きく1系と２系の２種類あるが、現時点でPythonは1系でのみExperimentalサポートという状況（ See also <a href="https://docs.microsoft.com/en-us/azure/azure-functions/supported-languages">言語サポート状況</a>）</p>
<p><img src="https://farm5.staticflickr.com/4638/38482890335_8c5083192d_z.jpg" width="640" height="523" alt="azure-functions-runtime-version"></p>
<p>Experimental（実験的サポート）なので本番での利用は非推奨であり、公式サポートはない（ベストエフォートでのサポートは得られるはず）。また、当然ながらGA言語に比べパフォーマンスは悪い。PythonはFunction呼び出し毎にpython.exeが実行される（GA言語はRuntimeと同じプロセスで実行）。</p>
<p>将来的な話をすると、Azure Functions Runtime 1系でのPythonサポートについては今のExperimentalの域を超えることはないだろう。一方、Runtime 2系ではPythonが正式サポートされるように対応が進められている。ただし時期は未定。この対応については下記Github Issueが切られており、ある程度の対応状況であれば確認可能。Pythonを使う利点の１つに、強力な数理計算、自然言語解析、機械学習系モジュールがあるが、早く安定とパフォーマンスが備わったPythonサーバレスアプリ実行環境でこれら強力なモジュールを活用できたらと思うのは私だけではないだろう。今後の進展に期待。</p>
<ul style="list-style:disc inside">
<li><a href="https://github.com/Azure/azure-webjobs-sdk-script/issues/335">Feature planning: first class Python support</a></li>
</ul>
<h2>Hosting Planの選択について</h2>
<h3>Consumption Plan vs App Service Plan</h3>
<p>Azure FunctionsのHosting PlanにはConsumption PlanとApp Service Planの2つがあって、言語に関係なく各プランの特徴は次の通り:</p>
<p><b>Consumption Plan</b></p>
<ul style="list-style:disc inside">
<li>コード実行時にコンピューティング割り当て</li>
<li>リソース使用量（関数実行時間、使用メモリ）で課金</li>
<li>自動スケール、各処理は〜10分まで</li>
</ul>
<p><b>App Service Plan</b></p>
<ul style="list-style:disc inside">
<li>専用VMでリソース確保</li>
<li>継続処理：10分以上の処理</li>
<li>App Service環境でのみ可能な処理: App Service Environment, VNET/VPN接続, より大きなサイズのVM, etc</li>
</ul>
<h3>Pythonで使う上で気をつけるポイント</h3>
<ul style="list-style:disc inside">
<li>Python 3.XなどRuntimeの変更を行う場合は、専用環境である必要があってApp Service Plan必須</li>
<li>Consumption Planの場合、Pythonに限らず<u>Coldスタート問題</u>という休眠したFunctionの起動が極端に遅くなる問題があるのだが、Pythonの場合は、GA言語に比べてパフォーマンスが悪く、SciPyなど重めのモジュールを利用すると絶望的に遅くなることからConsumption Planでの問題が特に顕著にでてくる。これまでの経験から、小さいインスタンスを並べるConsumption Planよりも比較的大きなサイズのVMが選べるApp Service Planの方が向いていることが多い。Pythonの場合は、予測可能なワークロードに対してApp Service Planで使うほうが問題が少ない。Consumption Planの魅力であるMicro Billing（使った分だけ課金）やリクエストに応じたオートスケーリングといった真のサーバレスに期待される要件は既に正式サポートしているC#、Nodeでやっていただくのがよいかと。</li>
</ul>
<h3>[参考] Coldスタート問題</h3>
<ul style="list-style:disc inside">
<li>Consumption Planにおける問題</li>
<li><a href="https://blog.kloud.com.au/2017/11/04/azure-functions-cold-start-workaround/">Azure Functions Cold Start Workaround</a></li>
<li>The only downside is that the consumption model that keeps the cost so dirt-cheap means that unless you are using your Function constantly (in which case, you might be better off with the non-consumption options anyway), you will often be hit with a long delay as your Function wakes up from hibernation</li>
<li>休眠したFunctionをどう起こすかがポイント。事前に空リクエストを送ることが考えられるが問題はタイミング（フォーム開いた時とか）</li>
</ul>
<h2>Python 3.Xランタイムへの変更方法</h2>
<p>2017年12月時点のAzure FunctionsのデフォルトPython Runtimeは2.7.8である。Site ExtensionにPython3.5系とPython3.6系が用意されているので、それを利用してFunctionsで利用するPython Runtimeを変更する方法を下記ページに纏めた。</p>
<ul style="list-style:disc inside">
<li><a href="https://github.com/yokawasa/azure-functions-python-samples/blob/master/docs/custom-python-version.md">How to change the Python version used in a Function App</a></li>
</ul>
<h2>モジュールのインストール方法</h2>
<p>pipとKudu DebugConsole/UIを利用した２種類のモジュールインストール方法を下記ページに纏めた。</p>
<ul style="list-style:disc inside">
<li><a href="https://github.com/yokawasa/azure-functions-python-samples/blob/master/docs/install-python-modules.md">How to install Python modules</a></li>
</ul>
<h2>Pythonサンプルコード</h2>
<p>私が試したTriggerとBinding利用サンプルコードは全て下記Githubプロジェクトに追加するようにしている。もしこれを読んでいる皆さんで下記プロジェクトでカバーされていないTrigger/Bindingの組み合わせを試されたら是非ともコントリビュートください。</p>
<ul style="list-style:disc inside">
<li><a href="https://github.com/yokawasa/azure-functions-python-samples">https://github.com/yokawasa/azure-functions-python-samples</a></li>
</ul>
<h2>スライドとHands-onマテリアル</h2>
<p>これは今年の<a href="https://azure.connpass.com/event/72312/">11月20日</a>a>と<a href="https://azure.connpass.com/event/72125/">11月28日</a>に<a href="https://azure.connpass.com/">Azure Antenna</a>で実施したHands-Onセッション（追記：その時の<a href="https://japan.zdnet.com/extra/azure_antenna_201712/35111765/">記事</a>）のスライドとHands-Onマテリアルである。よかったらこちらも参考にしていただければと思う。</p>
<p><iframe src="//www.slideshare.net/slideshow/embed_code/key/hZxsipR5VnWBJG" width="700" height="570.5" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>
<div style="margin-bottom:5px"> <strong> <a href="//www.slideshare.net/yokawasa/pythonazure-serverless-application-development-with-python-82884446" title="PythonによるAzureサーバレスアプリケーション開発 / Serverless Application Development with Python" target="_blank">PythonによるAzureサーバレスアプリケーション開発 / Serverless Application Development with Python</a> </strong> from <strong><a href="https://www.slideshare.net/yokawasa" target="_blank">Yoichi Kawasaki</a></strong> </div>
<p>Hands-onマテリアル：</p>
<ul style="list-style:disc inside">
<li><a href="https://github.com/yokawasa/azure-functions-python-samples/tree/master/handson">Hands-on: Serverless Application Development with Python</a></li>
</ul>
<p><br><br><br><br><br />
それでは、Enjoy Serverless Application Development with Python!</p>
