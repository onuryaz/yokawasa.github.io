---
layout: post
status: publish
published: true
title: azuresshconfigの紹介 - Azure上でのSSH生活を少しだけ快適にする
author:
  display_name: Yoichi Kawasaki
  login: yoichi
  email: yokawasa@gmail.com
  url: http://github.com/yokawasa
author_login: yoichi
author_email: yokawasa@gmail.com
author_url: http://github.com/yokawasa
wordpress_id: 91
wordpress_url: http://unofficialism.info/posts/?p=91
date: '2016-10-13 01:22:24 +0900'
date_gmt: '2016-10-12 16:22:24 +0900'
categories:
- Azure
tags:
- Python
- openssh
---
<p>UPDATED 2016-10-31: paramsオプション + Bash Completion追加</p>
<p>みんな大好きSSHとAzureのお話し。物理サーバ、EC2/仮想マシン、コンテナなどなんでもよいがその上にLinuxサーバをたてたらまずやることの1つにSSHログインのためにそのIPアドレス調べて~/.ssh/configにそのエントリーを追加してやることがあるんじゃないかと思います。この作業、エントリー数が少なければ大したことはないものの、追加対象のホストが大量にある場合はかなり面倒な作業になってきます。さらにDHCPなどでアドレスを動的に取得するような設定であればサーバの上げ下げのたびにIPアドレスが変わってくるので~/.ssh/configの更新が必要になってきて、どうしようもなく面倒になってきます。こういった単純でどうしようもなくつまらない作業は自動化したいですよね？ ここではそんな皆さんのために<a href="https://github.com/yokawasa/azure-ssh-config">azuresshconfig</a>というツールを紹介させていただきます。</p>
<p>これは皆さんのAzureサブスクリプション下に作られた仮想マシン一覧（ARMに限る）の情報を取得して各仮想マシンごとのエントリー情報（マシン名とIPアドレス）を~/.ssh/configに追加・更新してくれるツール。新規に仮想マシンを追加した際や、仮想マシンのIPアドレスが追加した際にはazuresshconfigを実行してあげることで~/.ssh/configが最新のエントリー情報でアップデートされ、各マシンにマシン名でSSHログインできるようになります。</p>
<p>ちなみに、~/.ssh/configとは何ですか？という人はQiitaの記事「<a href="http://qiita.com/passol78/items/2ad123e39efeb1a5286b">~/.ssh/configについて</a>」がとても分かりやすく書かれているので参考になるかと。</p>
<h2>インストール</h2>
<p>Pythonパッケージ管理ツールpipを使ってazuresshconfigをインストールしてください。インストール時に何かエラーが発生した場合は、<a href="https://github.com/yokawasa/azure-ssh-config/blob/master/Issues.md">こちら</a>のページを参照いただき特に該当する事象がないか確認ください。<br />
<code lang="bash"><br />
pip install azuresshconfig<br />
</code></p>
<h2>設定ファイルの編集（サービスプリンシパル）</h2>
<p><code lang="js"><br />
vi $HOME/.azure/azuresshconfig.json</p>
<p>{<br />
    "subscription_id": "<YOUR SUBSCRIPTION ID>",<br />
    "client_id": "<YOUR APPLICATION CLIENT IP>",<br />
    "client_scret": "<YOUR APPLICATION CLIENT SCRET>",<br />
    "tenant_id": "<YOUR TENANT ID>"<br />
}<br />
</code></p>
<p>サービスプリンシパルを作る必要があります。サービスプリンシパルの作り方が分からない人、とってもよいドキュメントがあります。こちらを参照ください：「<a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-authenticate-service-principal-cli/">Use Azure CLI to create a service principal to access resources</a>」</p>
<h2>使い方</h2>
<p><code><br />
azuresshconfig --help</p>
<p>usage: azuresshconfig.py [-h] [--version] [--init] [--profile PROFILE]<br />
                         [--user USER] [--identityfile IDENTITYFILE]<br />
                         [--private] [--resourcegroups RESOURCEGROUPS]<br />
                         [--params PARAMS]</p>
<p>This program generates SSH config from Azure ARM VM inventry in subscription</p>
<p>optional arguments:<br />
  -h, --help            show this help message and exit<br />
  --version             show program's version number and exit<br />
  --init                Create template client profile at<br />
                        $HOME/.azure/azuresshconfig.json only if there is no<br />
                        existing one<br />
  --profile PROFILE     Specify azure client profile file to use<br />
                        ($HOME/.azure/azuresshconfig.json by default)<br />
  --user USER           SSH username to use for all hosts<br />
  --identityfile IDENTITYFILE<br />
                        SSH identity file to use for all hosts<br />
  --private             Use private IP addresses (Public IP is used by<br />
                        default)<br />
  --resourcegroups RESOURCEGROUPS<br />
                        A comma-separated list of resource group to be<br />
                        considered for ssh-config generation (all resource<br />
                        groups by default)<br />
  --params PARAMS       Any ssh-config params you want to add with query-<br />
                        string format: key1=value1&key2=value2&...<br />
</code></p>
<h2>実行する</h2>
<h3>1. パラメータ指定なしで実行</h3>
<p><code><br />
azuresshconfig<br />
</code><br />
~/.ssh/configには下記のように### AZURE-SSH-CONFIG BEGIN ### ～ ### AZURE-SSH-CONFIG END ###のブロック内にマシン名とそのIPアドレス（デフォルト：パブリック）のエントリー一覧が追加・更新されます。</p>
<p><code><br />
cat ~/.ssh/config</p>
<p>### AZURE-SSH-CONFIG BEGIN ###</p>
<p>Host myvm1<br />
    HostName 40.74.124.30</p>
<p>Host myvm2<br />
    HostName 40.74.116.134<br />
....</p>
<p>### AZURE-SSH-CONFIG END ###<br />
</code></p>
<h3>2. SSHユーザと鍵指定</h3>
<p><code><br />
azuresshconfig --user yoichika --identityfile ~/.ssh/id_rsa<br />
</code></p>
<p>~/.ssh/configには各エントリーにIPアドレスに加えてユーザ名と鍵のパス情報が追加されます。</p>
<p><code><br />
cat ~/.ssh/config</p>
<p>### AZURE-SSH-CONFIG BEGIN ###</p>
<p>Host myvm1<br />
    HostName 40.74.124.30<br />
    IdentityFile /home/yoichika/.ssh/id_rsa<br />
    User yoichika</p>
<p>Host myvm2<br />
    HostName 40.74.116.134<br />
    IdentityFile /home/yoichika/.ssh/id_rsa<br />
    User yoichika<br />
....</p>
<p>### AZURE-SSH-CONFIG END ###<br />
</code></p>
<h3>3. プライベートIPを指定</h3>
<p><code><br />
azuresshconfig --user yoichika --identityfile ~/.ssh/id_rsa --private<br />
</code></p>
<p><strong>private</strong>オプションを付けて実行することで~/.ssh/configの各エントリーにはデフォルトのパブリックIPアドレスではなくてプライベートIPアドレスが追加されます。</p>
<h3>4. リソースグループで絞る</h3>
<p><code><br />
azuresshconfig --user yoichika --identityfile ~/.ssh/id_rsa --resourcegroups mygroup1,mygroup2<br />
</code><br />
<strong>resourcegroups</strong>オプションを指定することで指定されたリソースグループに所属する仮想マシンのエントリーのみが~/.ssh/configに追加されます。</p>
<h3>5. 追加ssh-configパラメータの指定</h3>
<p><code><br />
azuresshconfig.py --user yoichika \<br />
                --identityfile ~/.ssh/id_rsa \<br />
                --params "Port=2222&Protocol=2&UserKnownHostsFile=~/.ssh/known_hosts&ForwardAgent=yes"<br />
</code></p>
<p><strong>params</strong>オプションを指定することでその他指定可能なssh-configパラメータを追加することができます。上記のように<strong>params</strong>にssh-configのPort、Protocol、UserKnownHostsFile、ForwardAgentキーと値をセットすることで次のように出力されるssh-configに指定したキーと値がセットされます。</p>
<p><code><br />
cat ~/.ssh/config</p>
<p>### AZURE-SSH-CONFIG BEGIN ###</p>
<p>Host myvm1<br />
    HostName 40.74.124.30<br />
    IdentityFile ~/.ssh/id_rsa<br />
    User yoichika<br />
    Port 2222<br />
    Protocol 2<br />
    UserKnownHostsFile ~/.ssh/known_hosts<br />
    ForwardAgent yes</p>
<p>Host myvm2<br />
    HostName 40.74.116.134<br />
    IdentityFile /home/yoichika/.ssh/id_rsa<br />
    User yoichika<br />
    Port 2222<br />
    Protocol 2<br />
    UserKnownHostsFile ~/.ssh/known_hosts<br />
    ForwardAgent yes<br />
....</p>
<p>### AZURE-SSH-CONFIG END ###<br />
</code></p>
<h2>Shell Completion</h2>
<h3>Bashでの補完</h3>
<p>次のようにbash/<a href="https://github.com/yokawasa/azure-ssh-config/blob/master/bash/azuresshconfig_completion.bash">azuresshconfig_completion.bash</a>をbash起動時に読み込ませてあげることでazuresshconfigのパラメータ補完ができるようになります.<br />
<code><br />
# copy this under either of following directories<br />
cp azuresshconfig_completion.bash (/etc/bash_completion.d | /usr/local/etc/bash_completion.d | ~/bash_completion.d)</p>
<p># or append 'source /path/to/azuresshconfig_completion.bash' to .bashrc like this<br />
echo 'source /path/to/azuresshconfig_completion.bash' >> .bashrc<br />
</code></p>
<p>次のようにtabでazuresshconfigのパラメータ補完を行います。</p>
<p><code><br />
$ azuresshconfig -[tab]<br />
-h                --identityfile    --params          --profile         --user<br />
--help            --init            --private         --resourcegroups</p>
<p>$ azuresshconfig --i[tab]<br />
--identityfile  --init</p>
<p>$ azuresshconfig --p[tab]<br />
--params   --private  --profile</p>
<p>$ azuresshconfig --user [tab]<br />
$ azuresshconfig --user <ssh_user><br />
$ azuresshconfig --user <ssh_user> --identityfile [tab]<br />
$ azuresshconfig --user <ssh_user> --identityfile <ssh_identity_file><br />
</code></p>
<h2>その他</h2>
<p>インストール時のエラーや実行時のエラーについてはこちらに見つけ次第事象とその対応方法を追加しています。<br />
<a href="https://github.com/yokawasa/azure-ssh-config/blob/master/Issues.md">https://github.com/yokawasa/azure-ssh-config/blob/master/Issues.md</a></p>
<p>もしバグを見つけたり、追加機能のリクエストがある場合にこちらにIssue追加ください。頑張って時間をみつけて対応します。<br />
<a href="https://github.com/yokawasa/azure-ssh-config/issues">https://github.com/yokawasa/azure-ssh-config/issues</a></p>
<h2>LINKS</h2>
<ul style="list-style:disc inside">
<li><a href="https://github.com/yokawasa/azure-ssh-config">https://github.com/yokawasa/azure-ssh-config</a></li>
<li><a href="https://pypi.python.org/pypi/azuresshconfig/">https://pypi.python.org/pypi/azuresshconfig/</a></li>
<li><a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-authenticate-service-principal-cli/">Use Azure CLI to create a service principal to access resources</a></li>
</ul>
<p>azuresshconfig makes your SSH life on Azure easy!</p>
